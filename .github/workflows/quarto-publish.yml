name: Publish Quarto Book to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.3'
          use-public-rspm: true

      - name: Install Linux System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libglpk-dev \
            libxml2-dev \
            libcairo2-dev \
            libgit2-dev \
            default-jdk \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff-dev \
            libjpeg-dev \
            libxt-dev \
            libmagick++-dev

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ~/.local/share/r-lib
          key: ${{ runner.os }}-r-4.4.3-packages-v1
          restore-keys: |
            ${{ runner.os }}-r-4.4.3-

      - name: Install R packages
        run: |
          # Força usar Posit Package Manager com binários pré-compilados
          options(
            repos = c(CRAN = "https://packagemanager.posit.co/cran/__linux__/jammy/latest"),
            HTTPUserAgent = sprintf("R/%s R (%s)", getRversion(), 
                                   paste(getRversion(), R.version["platform"], 
                                         R.version["arch"], R.version["os"]))
          )
          
          # Instala todos os pacotes como binários (sem compilação!)
          install.packages(c(
            "tidyverse", "readxl", "janitor", "openxlsx",
            "car", "FSA", "nnet", "lmtest",
            "psych", "lavaan", "semPlot", "qgraph",
            "gtsummary", "broom.helpers", "officer", "flextable",
            "ggpubr", "vcd", "corrplot", "GGally", "sjPlot", "jtools",
            "tidytext", "wordcloud", "quanteda", "lexiconPT", "tm", 
            "stopwords", "mall", "rmarkdown", "knitr", "downlit", "xml2"
          ), dependencies = TRUE)
        shell: Rscript {0}

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: '1.4.550'

      - name: Render Quarto Book
        run: quarto render

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _book

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4